<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test Botones Simple</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>Test de Botones de Video</h2>
        
        <div class="alert alert-info">
            <strong>Instrucciones:</strong>
            <ol>
                <li>Abre la consola del navegador (F12)</li>
                <li>Haz click en los botones</li>
                <li>Observa los mensajes en la consola</li>
            </ol>
        </div>
        
        <div class="card mt-3">
            <div class="card-body">
                <h5>Video de Prueba</h5>
                <p>video_test.webm</p>
                
                <button class="btn btn-primary" 
                        data-filepath="/static/captures/video_test.webm" 
                        data-filename="video_test.webm" 
                        data-duration="5" 
                        data-notes="Test"
                        onclick="playVideoFromData(this)">
                    <i class="fas fa-play"></i> Reproducir
                </button>
                
                <button class="btn btn-success" 
                        data-filepath="/static/captures/video_test.webm" 
                        data-filename="video_test.webm"
                        onclick="downloadFileFromData(this)">
                    <i class="fas fa-download"></i> Descargar
                </button>
            </div>
        </div>
        
        <div class="mt-3">
            <h5>Consola de Pruebas:</h5>
            <div id="console" class="border p-3" style="background: #f5f5f5; min-height: 300px; font-family: monospace;"></div>
        </div>
    </div>

    <!-- Modal para reproducir video -->
    <div class="modal fade" id="videoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reproducir Video</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <video id="modalVideo" controls style="width: 100%; max-height: 500px; background: #000;">
                        Tu navegador no soporta el elemento de video.
                    </video>
                    <div id="videoInfo" class="mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="downloadVideoBtn">Descargar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentVideoPath = '';
        
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            console.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
            
            // También log en consola real
            if (type === 'error') {
                window.console.error(message);
            } else {
                window.console.log(message);
            }
        }

        function playVideoFromData(button) {
            log('✅ playVideoFromData() llamada', 'success');
            
            const filePath = button.getAttribute('data-filepath');
            const filename = button.getAttribute('data-filename');
            const duration = button.getAttribute('data-duration');
            const notes = button.getAttribute('data-notes');
            
            log(`  - filePath: ${filePath}`);
            log(`  - filename: ${filename}`);
            log(`  - duration: ${duration}`);
            log(`  - notes: ${notes}`);
            
            playVideo(filePath, filename, duration, notes);
        }

        function playVideo(filePath, filename, duration, notes) {
            log('✅ playVideo() llamada', 'success');
            log(`  - Abriendo modal para: ${filename}`);
            
            currentVideoPath = filePath;
            const modal = new bootstrap.Modal(document.getElementById('videoModal'));
            const video = document.getElementById('modalVideo');
            const videoInfo = document.getElementById('videoInfo');
            const downloadBtn = document.getElementById('downloadVideoBtn');
            
            // Limpiar video anterior
            video.pause();
            video.src = '';
            
            // Cargar nuevo video
            log(`  - Asignando src: ${filePath}`);
            video.src = filePath;
            video.load();
            
            // Event listeners
            video.addEventListener('loadstart', () => log('  ✓ Video: loadstart'));
            video.addEventListener('loadedmetadata', () => log('  ✓ Video: loadedmetadata'));
            video.addEventListener('loadeddata', () => log('  ✓ Video: loadeddata'));
            video.addEventListener('canplay', () => log('  ✓ Video: canplay', 'success'));
            video.addEventListener('error', (e) => {
                log('  ❌ Video error: ' + (video.error ? video.error.message : 'unknown'), 'error');
            });
            
            videoInfo.innerHTML = `
                <strong>${filename}</strong><br>
                ${duration ? `Duración: ${duration} segundos<br>` : ''}
                ${notes ? `Notas: ${notes}` : ''}
            `;
            
            downloadBtn.onclick = () => downloadFile(filePath, filename);
            
            modal.show();
            log('  ✓ Modal abierto', 'success');
            
            // Reproducir automáticamente
            video.play().catch(error => {
                log('  ⚠️ Autoplay bloqueado: ' + error.message);
            });
        }

        function downloadFileFromData(button) {
            log('✅ downloadFileFromData() llamada', 'success');
            
            const filePath = button.getAttribute('data-filepath');
            const filename = button.getAttribute('data-filename');
            
            log(`  - filePath: ${filePath}`);
            log(`  - filename: ${filename}`);
            
            downloadFile(filePath, filename);
        }

        function downloadFile(filePath, filename) {
            log('✅ downloadFile() llamada', 'success');
            log(`  - Descargando: ${filename}`);
            
            const link = document.createElement('a');
            link.href = filePath;
            link.download = filename;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            log('  ✓ Descarga iniciada', 'success');
        }

        // Log inicial
        log('=== TEST DE BOTONES INICIADO ===', 'success');
        log('Haz click en los botones para probar');
        log('');
    </script>
</body>
</html>
