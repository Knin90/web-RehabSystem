{% extends "patient/base_paciente.html" %}

{% block title %}Iniciar Rutina - RehabSystem{% endblock %}
{% block page_title %}Rutina guiada con visión artificial{% endblock %}
{% block page_description %}Activa tu cámara para que el sistema pueda analizar tus movimientos.{% endblock %}

{% block content %}
<div class="card card-custom mb-4">
    <div class="card-header-custom d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Sesión actual</h5>
        <span class="badge bg-primary">Rutina: Lumbar básica · 15 min</span>
    </div>
    <div class="card-body row g-4">
        <div class="col-lg-8">
            <div class="ratio ratio-16x9 border rounded position-relative bg-dark">
                <!-- Video de la cámara -->
                <video id="cameraVideo" autoplay playsinline class="w-100 h-100" style="object-fit: cover;"></video>

                <!-- Lienzo para MediaPipe (opcional luego) -->
                <canvas id="poseCanvas"
                        class="position-absolute top-0 start-0 w-100 h-100"
                        style="pointer-events: none;"></canvas>

                <div id="cameraOverlay"
                     class="position-absolute top-50 start-50 translate-middle text-center text-white">
                    <i class="fas fa-video fa-2x mb-2"></i>
                    <p class="mb-1">Haz clic en "Activar cámara" para comenzar</p>
                </div>
            </div>

            <div class="mt-3 d-flex justify-content-between align-items-center">
                <button id="startCameraBtn" class="btn btn-primary">
                    <i class="fas fa-video me-2"></i>Activar cámara
                </button>

                <button id="stopCameraBtn" class="btn btn-outline-secondary d-none">
                    <i class="fas fa-stop-circle me-2"></i>Detener
                </button>

                <div class="text-end flex-grow-1">
                    <span class="badge bg-success me-2" id="poseStatus">Detección: Inactiva</span>
                    <span class="badge bg-secondary">Repeticiones: <span id="repCount">0</span></span>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <h6>Pasos de la rutina</h6>
            <ol class="small">
                <li>Posiciónate frente a la cámara a una distancia cómoda.</li>
                <li>Sigue las indicaciones de postura en pantalla.</li>
                <li>Realiza flexiones suaves según el rango recomendado.</li>
                <li>Evita movimientos bruscos y detente si sientes dolor.</li>
            </ol>

            <hr>

            <h6>Indicaciones de seguridad</h6>
            <p class="small text-muted mb-0">
                Esta rutina ha sido prescrita por tu terapeuta. Si presentas mareos, dolor intenso
                o cualquier molestia inusual, detén la sesión y comunícate con tu especialista.
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let stream = null;
const video = document.getElementById('cameraVideo');
const overlay = document.getElementById('cameraOverlay');
const startBtn = document.getElementById('startCameraBtn');
const stopBtn = document.getElementById('stopCameraBtn');
const poseStatus = document.getElementById('poseStatus');

startBtn.addEventListener('click', async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
        overlay.classList.add('d-none');
        startBtn.classList.add('d-none');
        stopBtn.classList.remove('d-none');
        poseStatus.textContent = 'Detección: Preparando cámara';
        poseStatus.classList.remove('bg-success');
        poseStatus.classList.add('bg-warning');
        // Aquí luego conectas MediaPipe
    } catch (err) {
        alert('No se pudo acceder a la cámara. Verifica permisos.');
        console.error(err);
    }
});

stopBtn.addEventListener('click', () => {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }
    overlay.classList.remove('d-none');
    startBtn.classList.remove('d-none');
    stopBtn.classList.add('d-none');
    poseStatus.textContent = 'Detección: Inactiva';
    poseStatus.classList.remove('bg-warning');
    poseStatus.classList.add('bg-success');
});
</script>
{% endblock %}
